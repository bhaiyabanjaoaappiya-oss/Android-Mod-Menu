name: Android â€” Build & Release APK

on:
  push:
    tags:
      - 'v*'            # trigger on tags like v1.0.0
  workflow_dispatch:   # allow manual runs from Actions UI

env:
  GRADLE_OPTS: -Dorg.gradle.jvmargs=-Xmx3g

jobs:
  build-and-release:
    name: Build release APK and publish release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties') }}-${{ hashFiles('**/*.gradle*', '**/gradle/**') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Decode and write keystore
        if: secrets.KEYSTORE_BASE64 != ''
        run: |
          echo "Decoding KEYSTORE_BASE64 to $HOME/keystore.jks"
          echo "$KEYSTORE_BASE64" | base64 --decode > "$HOME/keystore.jks"
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      - name: Create keystore properties (for signing)
        run: |
          cat > $GITHUB_WORKSPACE/keystore.properties <<EOF
          storeFile=$HOME/keystore.jks
          storePassword=${KEYSTORE_PASSWORD}
          keyAlias=${KEY_ALIAS}
          keyPassword=${KEY_PASSWORD}
          EOF
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Print Java & Gradle versions
        run: |
          java -version
          ./gradlew -v

      - name: Clean and assemble release
        run: |
          ./gradlew clean
          ./gradlew assembleRelease --no-daemon --console=plain -x lint
        env:
          # Some Android projects expect ANDROID_HOME; GitHub runner includes Android SDK; this helps in some setups
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

      - name: Locate generated APK(s)
        id: find-apks
        run: |
          echo "Searching for APKs..."
          mkdir -p out
          # common locations
          find . -type f \( -path "*/outputs/apk/*/*.apk" -o -path "*/build/outputs/apk/**/*.apk" \) -print > apk-list.txt || true
          cat apk-list.txt || true
          if [ -s apk-list.txt ]; then
            APK_PATH=$(head -n 1 apk-list.txt)
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            cp "$APK_PATH" out/
          else
            echo "No APK found" && exit 1
          fi

      - name: Upload APK artifact (actions artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: out/*.apk

      - name: Create GitHub Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Automated release built by GitHub Actions for tag ${{ github.ref_name }}.
            Commit: ${{ github.sha }}
          draft: false
          prerelease: false

      - name: Upload APK to Release
        uses: softprops/action-gh-release@v1
        with:
          files: out/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output release URL
        run: |
          echo "Release created for tag ${{ github.ref_name }}"
